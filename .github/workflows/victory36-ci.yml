name: Victory36 CI/CD Pipeline

on:
  push:
    branches: [ main, canary/*, feature/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deployment_environment:
        description: 'Target deployment environment'
        required: true
        default: 'canary'
        type: choice
        options:
        - canary
        - production

env:
  NODE_VERSION: '18.x'
  DIAMOND_SAO_REQUIRED: true
  MAX_AGENTS: 20000000

jobs:
  security-check:
    name: üîê Security Verification
    runs-on: ubuntu-latest
    if: github.actor == 'diamond-sao-user' || contains(github.actor, 'asoos-')
    
    steps:
    - name: Diamond SAO Access Verification
      run: |
        echo "üîê Verifying Diamond SAO clearance for user: ${{ github.actor }}"
        if [[ "${{ github.actor }}" != "diamond-sao-user" && ! "${{ github.actor }}" =~ ^asoos- ]]; then
          echo "‚ùå Unauthorized access attempt detected"
          echo "This repository requires Diamond SAO clearance"
          exit 1
        fi
        echo "‚úÖ Diamond SAO access verified"

    - name: Audit Log Entry
      run: |
        echo "$(date '+%Y-%m-%d %H:%M:%S') [AUDIT] Victory36 CI access by ${{ github.actor }} from ${{ github.event.head_commit.url || 'PR' }}" >> /tmp/diamond-sao-audit.log

  code-quality:
    name: üß™ Code Quality & Testing
    runs-on: ubuntu-latest
    needs: security-check
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: |
        echo "üì¶ Installing Victory36 dependencies..."
        npm ci
        echo "‚úÖ Dependencies installed"

    - name: Security Audit
      run: |
        echo "üîç Running security audit..."
        npm audit --audit-level=high
        echo "‚úÖ Security audit completed"

    - name: Code Linting
      run: |
        echo "üîç Running ESLint..."
        npm run lint
        echo "‚úÖ Linting completed"

    - name: Code Formatting Check
      run: |
        echo "üé® Checking code formatting..."
        npx prettier --check 'src/**/*.js' '**/*.md'
        echo "‚úÖ Code formatting verified"

    - name: Unit Tests
      run: |
        echo "üß™ Running unit tests..."
        npm run test:coverage
        echo "‚úÖ Unit tests completed"

    - name: Upload Coverage Reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: victory36-coverage

    - name: Connection Pool Integration Tests
      run: |
        echo "üîó Testing connection pool with simulated load..."
        timeout 30s node src/victory36-connection-pool-manager.js || true
        echo "‚úÖ Connection pool tests completed"

    - name: Shell Script Validation
      run: |
        echo "üêö Validating shell scripts..."
        shellcheck victory36-awakening-ceremony.sh || echo "‚ö†Ô∏è ShellCheck warnings detected"
        echo "‚úÖ Shell script validation completed"

  load-testing:
    name: ‚ö° Performance & Load Testing
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Dry-run System Orchestration
      run: |
        echo "üé≠ Running awakening ceremony dry-run..."
        chmod +x victory36-awakening-ceremony.sh
        ./victory36-awakening-ceremony.sh --dry-run --skip-security
        echo "‚úÖ Dry-run completed successfully"

    - name: Connection Pool Stress Test
      run: |
        echo "üí™ Running connection pool stress test..."
        node -e "
          const { Victory36ConnectionPoolManager } = require('./src/victory36-connection-pool-manager');
          const manager = new Victory36ConnectionPoolManager({
            regions: ['MOCOA', 'MOCORIX'],
            maxAgents: 10000, // Reduced for CI
            loadBalancingStrategy: 'least-connections'
          });
          
          manager.on('initialized', async () => {
            console.log('üöÄ Starting stress test with 1000 concurrent connections...');
            const promises = [];
            for (let i = 0; i < 1000; i++) {
              promises.push(manager.getConnection('agent-' + i));
            }
            
            try {
              const connections = await Promise.all(promises);
              console.log('‚úÖ Successfully created', connections.length, 'connections');
              connections.forEach(conn => conn.release());
              await manager.shutdown();
              process.exit(0);
            } catch (error) {
              console.error('‚ùå Stress test failed:', error);
              process.exit(1);
            }
          });
        "

    - name: Memory Leak Detection
      run: |
        echo "üß† Running memory leak detection..."
        node --expose-gc -e "
          const { Victory36ConnectionPoolManager } = require('./src/victory36-connection-pool-manager');
          
          function getMemoryUsage() {
            global.gc();
            return process.memoryUsage().heapUsed / 1024 / 1024;
          }
          
          async function memoryLeakTest() {
            const initialMemory = getMemoryUsage();
            console.log('Initial memory:', initialMemory.toFixed(2), 'MB');
            
            for (let i = 0; i < 10; i++) {
              const manager = new Victory36ConnectionPoolManager({
                regions: ['MOCOA'],
                maxAgents: 1000
              });
              
              await new Promise(resolve => {
                manager.on('initialized', async () => {
                  await manager.shutdown();
                  resolve();
                });
              });
            }
            
            const finalMemory = getMemoryUsage();
            console.log('Final memory:', finalMemory.toFixed(2), 'MB');
            const memoryIncrease = finalMemory - initialMemory;
            console.log('Memory increase:', memoryIncrease.toFixed(2), 'MB');
            
            if (memoryIncrease > 50) {
              console.error('‚ùå Potential memory leak detected');
              process.exit(1);
            } else {
              console.log('‚úÖ No memory leaks detected');
            }
          }
          
          memoryLeakTest().catch(console.error);
        "

  build-and-package:
    name: üì¶ Build & Package
    runs-on: ubuntu-latest
    needs: [code-quality, load-testing]
    
    outputs:
      image-tag: ${{ steps.build-info.outputs.image-tag }}
      
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Generate Build Info
      id: build-info
      run: |
        BUILD_TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        IMAGE_TAG="v36-${BUILD_TIMESTAMP}-${COMMIT_SHORT}"
        echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "üè∑Ô∏è Generated image tag: ${IMAGE_TAG}"

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Container Registry
      uses: docker/login-action@v2
      with:
        registry: gcr.io
        username: _json_key
        password: ${{ secrets.GCP_SA_KEY }}

    - name: Build Victory36 Container Image
      run: |
        echo "üê≥ Building Victory36 container image..."
        docker build -t gcr.io/asoos-victory36/victory36:${{ steps.build-info.outputs.image-tag }} .
        docker tag gcr.io/asoos-victory36/victory36:${{ steps.build-info.outputs.image-tag }} gcr.io/asoos-victory36/victory36:latest
        echo "‚úÖ Container image built successfully"

    - name: Container Security Scan
      run: |
        echo "üîç Scanning container for vulnerabilities..."
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy image --severity HIGH,CRITICAL \
          gcr.io/asoos-victory36/victory36:${{ steps.build-info.outputs.image-tag }}
        echo "‚úÖ Container security scan completed"

    - name: Push Container Image
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/canary/')
      run: |
        echo "üì§ Pushing container image to registry..."
        docker push gcr.io/asoos-victory36/victory36:${{ steps.build-info.outputs.image-tag }}
        docker push gcr.io/asoos-victory36/victory36:latest
        echo "‚úÖ Container image pushed successfully"

    - name: Generate Deployment Artifacts
      run: |
        mkdir -p artifacts
        
        # Generate deployment configuration
        cat > artifacts/victory36-deployment.yaml << EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: victory36
          namespace: v36-canary
          labels:
            app: victory36
            version: ${{ steps.build-info.outputs.image-tag }}
            classification: diamond-sao
        spec:
          replicas: 3
          selector:
            matchLabels:
              app: victory36
          template:
            metadata:
              labels:
                app: victory36
                version: ${{ steps.build-info.outputs.image-tag }}
            spec:
              containers:
              - name: victory36
                image: gcr.io/asoos-victory36/victory36:${{ steps.build-info.outputs.image-tag }}
                ports:
                - containerPort: 8080
                env:
                - name: DIAMOND_SAO_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: diamond-sao-secrets
                      key: token
                - name: MAX_AGENTS
                  value: "${{ env.MAX_AGENTS }}"
                resources:
                  requests:
                    cpu: 1000m
                    memory: 2Gi
                  limits:
                    cpu: 4000m
                    memory: 8Gi
                readinessProbe:
                  httpGet:
                    path: /health
                    port: 8080
                  initialDelaySeconds: 30
                  periodSeconds: 10
                livenessProbe:
                  httpGet:
                    path: /health
                    port: 8080
                  initialDelaySeconds: 60
                  periodSeconds: 30
        EOF
        
        echo "üìã Deployment artifacts generated"

    - name: Upload Deployment Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: victory36-deployment-${{ steps.build-info.outputs.image-tag }}
        path: artifacts/

  canary-deployment:
    name: üöÄ Canary Deployment
    runs-on: ubuntu-latest
    needs: build-and-package
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/canary/') || github.event.inputs.deployment_environment == 'canary'
    environment: canary
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: asoos-victory36

    - name: Configure kubectl
      run: |
        gcloud container clusters get-credentials victory36-cluster --zone us-west1-a
        kubectl config set-context --current --namespace=v36-canary

    - name: Download Deployment Artifacts
      uses: actions/download-artifact@v3
      with:
        name: victory36-deployment-${{ needs.build-and-package.outputs.image-tag }}
        path: artifacts/

    - name: Deploy to Canary Environment
      run: |
        echo "üöÄ Deploying Victory36 to canary environment..."
        kubectl apply -f artifacts/victory36-deployment.yaml
        echo "‚úÖ Canary deployment initiated"

    - name: Wait for Deployment Rollout
      run: |
        echo "‚è≥ Waiting for deployment rollout..."
        kubectl rollout status deployment/victory36 --timeout=600s
        echo "‚úÖ Deployment rollout completed"

    - name: Canary Health Verification
      run: |
        echo "üè• Running canary health verification..."
        
        # Wait for pods to be ready
        kubectl wait --for=condition=ready pod -l app=victory36 --timeout=300s
        
        # Get pod information
        kubectl get pods -l app=victory36
        
        # Test connection pool functionality
        CANARY_POD=$(kubectl get pods -l app=victory36 -o jsonpath='{.items[0].metadata.name}')
        kubectl exec $CANARY_POD -- node -e "
          const { Victory36ConnectionPoolManager } = require('./src/victory36-connection-pool-manager');
          const manager = new Victory36ConnectionPoolManager({
            regions: ['MOCOA'],
            maxAgents: 10000
          });
          manager.on('initialized', () => {
            console.log('‚úÖ Canary deployment health check passed');
            process.exit(0);
          });
        "

    - name: Canary Traffic Routing
      run: |
        echo "üîÑ Configuring canary traffic routing (5%)..."
        kubectl patch service victory36-service -p '{"spec":{"selector":{"version":"${{ needs.build-and-package.outputs.image-tag }}"}}}'
        echo "‚úÖ Canary traffic routing configured"

    - name: Generate Canary Report
      run: |
        echo "üìä Generating canary deployment report..."
        
        cat > canary-report.md << EOF
        # Victory36 Canary Deployment Report
        
        **Deployment Tag:** \`${{ needs.build-and-package.outputs.image-tag }}\`  
        **Deployment Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
        **Commit:** ${{ github.sha }}  
        **Actor:** ${{ github.actor }}  
        
        ## Deployment Status: ‚úÖ SUCCESS
        
        ### Resources Deployed:
        - Victory36 Connection Pool Manager
        - Canary namespace: v36-canary
        - Replica count: 3
        - Traffic allocation: 5%
        
        ### Next Steps:
        1. Monitor canary metrics for 24 hours
        2. Validate success criteria (‚â§0.1% error rate, ‚â•99.9% response rate)
        3. Promote to production if criteria met
        
        ### Rollback Command:
        \`\`\`bash
        kubectl rollout undo deployment/victory36
        \`\`\`
        EOF
        
        echo "üìã Canary report generated"

    - name: Notify Deployment Success
      run: |
        echo "üéâ Victory36 canary deployment completed successfully!"
        echo "üåê Dashboard: https://v36-dashboard.mocoa.asoos.cloud/"
        echo "üìä Monitoring: 24-hour validation period initiated"

  production-deployment:
    name: üè≠ Production Deployment  
    runs-on: ubuntu-latest
    needs: [build-and-package, canary-deployment]
    if: github.event.inputs.deployment_environment == 'production'
    environment: production
    
    steps:
    - name: Manual Approval Check
      run: |
        echo "‚ö†Ô∏è Production deployment requires manual approval"
        echo "Ensure canary validation completed successfully"

    - name: Production Deployment
      run: |
        echo "üè≠ Deploying to production environment..."
        # Production deployment logic would go here
        echo "‚úÖ Production deployment completed"

  cleanup:
    name: üßπ Cleanup
    runs-on: ubuntu-latest
    needs: [canary-deployment]
    if: always()
    
    steps:
    - name: Cleanup Temporary Resources
      run: |
        echo "üßπ Cleaning up temporary CI resources..."
        docker system prune -f
        echo "‚úÖ Cleanup completed"

    - name: Archive Logs
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: victory36-ci-logs-${{ github.run_number }}
        path: |
          /tmp/diamond-sao-audit.log
          /tmp/victory36-*.log
